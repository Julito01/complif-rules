<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Complif — Rule Engine Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --orange: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .header h1 span {
      color: var(--accent);
    }

    .header .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .header .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot.connected {
      background: var(--green);
    }

    .dot.disconnected {
      background: var(--red);
    }

    .controls {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .controls label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .controls input,
    .controls select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
    }

    .controls button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .controls button:hover {
      opacity: 0.9;
    }

    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }

    .stat-card .sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h2 {
      font-size: 15px;
      font-weight: 600;
    }

    .panel-header .badge {
      background: var(--accent);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .panel-body {
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--card);
    }

    table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .severity {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .severity.CRITICAL {
      background: rgba(239, 68, 68, 0.2);
      color: var(--red);
    }

    .severity.HIGH {
      background: rgba(249, 115, 22, 0.2);
      color: var(--orange);
    }

    .severity.MEDIUM {
      background: rgba(234, 179, 8, 0.2);
      color: var(--yellow);
    }

    .severity.LOW {
      background: rgba(34, 197, 94, 0.2);
      color: var(--green);
    }

    .decision {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .decision.ALLOW {
      background: rgba(34, 197, 94, 0.2);
      color: var(--green);
    }

    .decision.REVIEW {
      background: rgba(234, 179, 8, 0.2);
      color: var(--yellow);
    }

    .decision.BLOCK {
      background: rgba(239, 68, 68, 0.2);
      color: var(--red);
    }

    .status-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.OPEN {
      background: rgba(239, 68, 68, 0.2);
      color: var(--red);
    }

    .status-badge.ACKNOWLEDGED {
      background: rgba(234, 179, 8, 0.2);
      color: var(--yellow);
    }

    .status-badge.RESOLVED {
      background: rgba(34, 197, 94, 0.2);
      color: var(--green);
    }

    .status-badge.DISMISSED {
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
    }

    .live-feed {
      max-height: 300px;
      overflow-y: auto;
    }

    .feed-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      animation: fadeIn 0.3s ease;
    }

    .feed-item .time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .feed-item .content {
      font-size: 13px;
      margin-top: 4px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .empty {
      padding: 40px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .mono {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
    }

    .truncate {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1><span>Complif</span> — Rule Engine Dashboard</h1>
    <div class="status">
      <div class="dot" id="wsDot"></div>
      <span id="wsStatus">Connecting...</span>
    </div>
  </div>

  <div class="controls">
    <label>Organization:</label>
    <input type="text" id="orgInput" value="complif-001" placeholder="Organization ID" />
    <button onclick="loadAll()">Load Data</button>
    <button onclick="connectWS()">Connect Live</button>
    <label style="margin-left: auto;">API:</label>
    <input type="text" id="apiUrl" value="" placeholder="http://localhost:3000" style="width: 200px;" />
  </div>

  <div class="container">
    <!-- Stats row -->
    <div class="stats">
      <div class="stat-card">
        <div class="label">Active Rules</div>
        <div class="value" id="statRules">—</div>
        <div class="sub">Rule versions enabled</div>
      </div>
      <div class="stat-card">
        <div class="label">Transactions</div>
        <div class="value" id="statTxn">—</div>
        <div class="sub">Total ingested</div>
      </div>
      <div class="stat-card">
        <div class="label">Open Alerts</div>
        <div class="value" id="statAlerts">—</div>
        <div class="sub">Pending review</div>
      </div>
      <div class="stat-card">
        <div class="label">Templates</div>
        <div class="value" id="statTemplates">—</div>
        <div class="sub">Rule templates</div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid">
      <!-- Active Rules -->
      <div class="panel">
        <div class="panel-header">
          <h2>Active Rule Versions</h2>
          <span class="badge" id="ruleBadge">0</span>
        </div>
        <div class="panel-body">
          <table>
            <thead>
              <tr>
                <th>Template</th>
                <th>Version</th>
                <th>Priority</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody id="rulesTable">
              <tr>
                <td colspan="4" class="empty">Click "Load Data" to fetch</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Alerts -->
      <div class="panel">
        <div class="panel-header">
          <h2>Recent Alerts</h2>
          <span class="badge" id="alertBadge">0</span>
        </div>
        <div class="panel-body">
          <table>
            <thead>
              <tr>
                <th>Severity</th>
                <th>Category</th>
                <th>Status</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="alertsTable">
              <tr>
                <td colspan="4" class="empty">Click "Load Data" to fetch</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rule Templates -->
      <div class="panel">
        <div class="panel-header">
          <h2>Rule Templates</h2>
          <span class="badge" id="templateBadge">0</span>
        </div>
        <div class="panel-body">
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Category</th>
                <th>Active</th>
              </tr>
            </thead>
            <tbody id="templatesTable">
              <tr>
                <td colspan="4" class="empty">Click "Load Data" to fetch</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Live Feed -->
      <div class="panel">
        <div class="panel-header">
          <h2>Live Evaluation Feed</h2>
          <span class="badge" id="feedBadge">0</span>
        </div>
        <div class="panel-body live-feed" id="liveFeed">
          <div class="empty">Connect to WebSocket for live updates</div>
        </div>
      </div>
    </div>

    <!-- Recent Evaluations -->
    <div class="panel" style="margin-bottom: 24px;">
      <div class="panel-header">
        <h2>Recent Evaluations</h2>
        <span class="badge" id="evalBadge">0</span>
      </div>
      <div class="panel-body">
        <table>
          <thead>
            <tr>
              <th>Transaction</th>
              <th>Account</th>
              <th>Decision</th>
              <th>Triggered</th>
              <th>Duration</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="evalsTable">
            <tr>
              <td colspan="6" class="empty">Click "Load Data" to fetch</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Auto-detect API URL
    const defaultApi = window.location.origin === 'file://' ? 'http://localhost:3000' : window.location.origin
    document.getElementById('apiUrl').value = defaultApi

    function getApi() { return document.getElementById('apiUrl').value.replace(/\/$/, '') }
    function getOrg() { return document.getElementById('orgInput').value }
    function headers() { return { 'x-organization-id': getOrg(), 'Content-Type': 'application/json' } }

    let feedCount = 0
    let ws = null
    const FEED_RENDER_INTERVAL_MS = 400
    const FEED_MAX_ITEMS = 50
    const feedQueue = []
    let feedTimer = null

    function renderFeedItem(html) {
      const feed = document.getElementById('liveFeed')
      if (feed.querySelector('.empty')) feed.innerHTML = ''
      const item = document.createElement('div')
      item.className = 'feed-item'
      item.innerHTML = html
      feed.prepend(item)
      while (feed.children.length > FEED_MAX_ITEMS) feed.removeChild(feed.lastChild)
    }

    function ensureFeedTimer() {
      if (feedTimer) return
      feedTimer = setInterval(() => {
        if (feedQueue.length === 0) return
        const next = feedQueue.shift()
        renderFeedItem(next)
      }, FEED_RENDER_INTERVAL_MS)
    }

    function stopFeedTimer() {
      if (!feedTimer) return
      clearInterval(feedTimer)
      feedTimer = null
    }

    function enqueueFeedItem(html) {
      feedQueue.push(html)
      ensureFeedTimer()
    }

    async function loadAll() {
      await Promise.all([loadRules(), loadAlerts(), loadTemplates(), loadEvaluations(), loadTransactions()])
    }

    async function loadRules() {
      try {
        const res = await fetch(`${getApi()}/rule-versions/active`, { headers: headers() })
        const json = await res.json()
        const rules = json.data || []
        document.getElementById('statRules').textContent = rules.length
        document.getElementById('ruleBadge').textContent = rules.length
        const tbody = document.getElementById('rulesTable')
        if (rules.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty">No active rules</td></tr>'; return }
        tbody.innerHTML = rules.map(r => `
          <tr>
            <td class="mono"><span class="truncate" title="${r.idRuleTemplate}">${r.idRuleTemplate?.slice(0, 8) || '—'}...</span></td>
            <td>v${r.versionNumber}</td>
            <td>${r.priority}</td>
            <td>${r.category || '—'}</td>
          </tr>
        `).join('')
      } catch (e) { console.error('Rules:', e) }
    }

    async function loadAlerts() {
      try {
        const res = await fetch(`${getApi()}/alerts?limit=50`, { headers: headers() })
        const json = await res.json()
        const alerts = json.data || []
        const open = alerts.filter(a => a.status === 'OPEN').length
        document.getElementById('statAlerts').textContent = open
        document.getElementById('alertBadge').textContent = alerts.length
        const tbody = document.getElementById('alertsTable')
        if (alerts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty">No alerts</td></tr>'; return }
        tbody.innerHTML = alerts.slice(0, 30).map(a => `
          <tr>
            <td><span class="severity ${a.severity}">${a.severity}</span></td>
            <td>${a.category || '—'}</td>
            <td><span class="status-badge ${a.status}">${a.status}</span></td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${a.message || '—'}</td>
          </tr>
        `).join('')
      } catch (e) { console.error('Alerts:', e) }
    }

    async function loadTemplates() {
      try {
        const res = await fetch(`${getApi()}/rule-templates`, { headers: headers() })
        const json = await res.json()
        const templates = json.data || []
        document.getElementById('statTemplates').textContent = templates.length
        document.getElementById('templateBadge').textContent = templates.length
        const tbody = document.getElementById('templatesTable')
        if (templates.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty">No templates</td></tr>'; return }
        tbody.innerHTML = templates.map(t => `
          <tr>
            <td class="mono">${t.code}</td>
            <td>${t.name}</td>
            <td>${t.category || '—'}</td>
            <td>${t.isActive ? '✓' : '✗'}</td>
          </tr>
        `).join('')
      } catch (e) { console.error('Templates:', e) }
    }

    async function loadEvaluations() {
      try {
        const res = await fetch(`${getApi()}/transactions/evaluations?limit=20`, { headers: headers() })
        const json = await res.json()
        const evals = json.data || []
        document.getElementById('evalBadge').textContent = json.totalCount ?? evals.length
        const tbody = document.getElementById('evalsTable')
        if (evals.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="empty">No evaluations</td></tr>'; return }
        tbody.innerHTML = evals.map(e => `
          <tr>
            <td class="mono"><span class="truncate" title="${e.idTransaction}">${(e.idTransaction || '').slice(0, 8)}...</span></td>
            <td class="mono"><span class="truncate" title="${e.idAccount}">${(e.idAccount || '').slice(0, 8)}...</span></td>
            <td><span class="decision ${e.decision}">${e.decision}</span></td>
            <td>${Array.isArray(e.triggeredRules) ? e.triggeredRules.length : 0}</td>
            <td>${e.evaluationDurationMs || 0}ms</td>
            <td class="mono">${e.createdAt ? new Date(e.createdAt).toLocaleTimeString() : '—'}</td>
          </tr>
        `).join('')
      } catch (e) { console.error('Evals:', e) }
    }

    async function loadTransactions() {
      try {
        const res = await fetch(`${getApi()}/transactions?limit=50`, { headers: headers() })
        const json = await res.json()
        document.getElementById('statTxn').textContent = json.totalCount ?? json.count ?? 0
      } catch (e) { console.error('Txn:', e) }
    }

    function connectWS() {
      if (ws) { ws.close(); ws = null }
      feedQueue.length = 0
      const dot = document.getElementById('wsDot')
      const status = document.getElementById('wsStatus')

      // Load Socket.IO client dynamically
      if (!window.io) {
        const script = document.createElement('script')
        script.src = 'https://cdn.socket.io/4.7.5/socket.io.min.js'
        script.onload = () => initWS(dot, status)
        document.head.appendChild(script)
      } else {
        initWS(dot, status)
      }
    }

    function initWS(dot, status) {
      const apiUrl = getApi()
      ws = io(`${apiUrl}/evaluations`, { transports: ['websocket', 'polling'] })

      ws.on('connect', () => {
        dot.className = 'dot connected'
        status.textContent = 'Connected'
        ws.emit('subscribe', { organizationId: getOrg() })
      })

      ws.on('disconnect', () => {
        dot.className = 'dot disconnected'
        status.textContent = 'Disconnected'
        stopFeedTimer()
      })

      ws.on('evaluation:result', (data) => {
        feedCount++
        document.getElementById('feedBadge').textContent = feedCount
        enqueueFeedItem(`
          <div class="time">${new Date(data.timestamp).toLocaleTimeString()}</div>
          <div class="content">
            <span class="decision ${data.decision}">${data.decision}</span>
            Txn <span class="mono">${data.transactionId?.slice(0, 8)}...</span> —
            ${data.triggeredRulesCount}/${data.totalRulesEvaluated} rules triggered
            (${data.evaluationDurationMs}ms)
          </div>
        `)
      })

      ws.on('evaluation:alert', (data) => {
        enqueueFeedItem(`
          <div class="time">${new Date(data.timestamp).toLocaleTimeString()}</div>
          <div class="content">
            <span class="severity ${data.severity}">${data.severity}</span>
            ALERT: ${data.message}
          </div>
        `)
      })

      ws.on('connect_error', (err) => {
        dot.className = 'dot disconnected'
        status.textContent = `Error: ${err.message}`
        stopFeedTimer()
      })
    }

    // Auto-load on page open
    window.addEventListener('DOMContentLoaded', () => { loadAll() });
  </script>
</body>

</html>